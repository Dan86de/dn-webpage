---
export const prerender = false;

import { getCollection } from "astro:content";
import Layout from "@/layouts/Layout.astro";
import SEO from "@/components/SEO.astro";
import { getReadingTime } from "@/lib/readingTime";

// Query all blog posts and filter out drafts
const allPosts = await getCollection("blog");
const publishedPosts = allPosts
  .filter((post) => !post.data.isDraft)
  .sort((a, b) => b.data.publishDate.getTime() - a.data.publishDate.getTime());

// Get selected tag from URL query param
const selectedTag = Astro.url.searchParams.get("tag");

// Filter posts by tag if one is selected
const posts = selectedTag
  ? publishedPosts.filter((post) => post.data.tags.includes(selectedTag))
  : publishedPosts;

// Extract all unique tags with counts
const tagCounts = new Map<string, number>();
publishedPosts.forEach((post) => {
  post.data.tags.forEach((tag) => {
    tagCounts.set(tag, (tagCounts.get(tag) || 0) + 1);
  });
});
const allTags = Array.from(tagCounts.entries()).sort((a, b) =>
  a[0].localeCompare(b[0])
);

// Site URL for SEO
const siteUrl = "http://localhost:4321";
---

<Layout>
  <SEO
    slot="head"
    title="Blog - Daniel Noworyta"
    description="Articles about web development, TypeScript, React, and software engineering."
    canonicalURL={`${siteUrl}/blog`}
    type="website"
  />
  <div class="px-(--inline-padding)">
    <div class="max-w-4xl mx-auto py-12">
      <header class="mb-12">
        <h1
          class="bg-brand-gradient bg-clip-text text-transparent font-medium pb-4"
        >
          Blog
        </h1>
        <p class="text-gray-600 dark:text-gray-400 text-lg">
          Articles about web development, TypeScript, React, and software
          engineering.
        </p>
      </header>

      <!-- Tag filter -->
      <div class="mb-8">
        <div class="flex flex-wrap gap-2">
          <a
            href="/blog"
            class:list={[
              "px-3 py-1.5 text-sm rounded-md transition-colors",
              !selectedTag
                ? "bg-orange-500 text-white"
                : "bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700",
            ]}
          >
            All posts ({publishedPosts.length})
          </a>
          {
            allTags.map(([tag, count]) => (
              <a
                href={`/blog?tag=${encodeURIComponent(tag)}`}
                class:list={[
                  "px-3 py-1.5 text-sm rounded-md transition-colors",
                  selectedTag === tag
                    ? "bg-orange-500 text-white"
                    : "bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700",
                ]}
              >
                {tag} ({count})
              </a>
            ))
          }
        </div>
      </div>

      <!-- Blog post list -->
      <div class="space-y-0">
        {
          posts.map((post) => {
            const readingTime = getReadingTime(post.body || "");
            const formattedDate = post.data.publishDate.toLocaleDateString(
              "en-US",
              {
                year: "numeric",
                month: "short",
                day: "numeric",
              }
            );

            return (
              <a
                href={`/blog/${post.data.slug}`}
                class="group block py-12 border-b border-gray-200 dark:border-gray-800 last:border-b-0 hover:border-gray-300 dark:hover:border-gray-700 transition-colors"
              >
                <article class="flex gap-8 items-start">
                  <div class="flex-1">
                    <h2 class="text-2xl font-medium mb-4 group-hover:bg-brand-gradient group-hover:bg-clip-text group-hover:text-transparent transition-colors">
                      {post.data.title}
                    </h2>
                    <p class="text-gray-600 dark:text-gray-400 text-base leading-relaxed">
                      {post.data.description}
                    </p>
                  </div>
                  <div class="text-right text-sm text-gray-500 dark:text-gray-500 flex-shrink-0">
                    <div class="font-medium mb-1">Article</div>
                    <div>{formattedDate}</div>
                  </div>
                </article>
              </a>
            );
          })
        }
      </div>
    </div>
  </div>
</Layout>
